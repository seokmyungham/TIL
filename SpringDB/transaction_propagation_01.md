# 트랜잭션 전파(Transaction Propagation)

## 트랜잭션 전파란?

트랜잭션을 각각 사용하는 것이 아니라,  
이미 트랜잭션이 진행중인데 추가로 트랜잭션을 수행하는 경우에 어떻게 동작할지 결정하는 것을 트랜잭션 전파라 한다.

## 스프링 트랜잭션 전파 기본(REQUIRED)

![](img/tx_propa_01.PNG)

- 외부 트랜잭션 수행중에 내부 트랜잭션이 추가로 수행되는 경우, 스프링은 하나의 물리 트랜잭션이라는 개념으로 두 트랜잭션을 묶어준다.
- 이 때 내부 트랜잭션이 외부 트랜잭션에 참여하게 된다.
- 물리 트랜잭션은 우리가 실제 데이터베이스에 적용되는 트랜잭션을 뜻한다. 실제 커넥션을 통해 트랜잭션을 시작, 커밋, 롤백하는 단위이다.
- 논리 트랜잭션은 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위이다.

트랜잭션 전파 원칙은 다음과 같다.

### 원칙

- **모든 논리 트랜잭션이 커밋되어야 물리 트랜잭션이 커밋된다.**
- **하나의 논리 트랜잭션이라도 롤백되면 물리 트랜잭션은 롤백된다.**

#

## 트랜잭션 전파 실제 동작

![](img/tx_propa_02.PNG)

- 스프링은 여러 트랜잭션이 함꼐 사용되는 경우, 처음 트랜잭션을 시작한 외부 트랜잭션이 실제 물리 트랜잭션을 관리하도록 한다.
- 트랜잭션 매니저는 트랜잭션 생성 결과를 TransactionStatus에 담아서 반환하고, 여기에는 신규 트랜잭션의 여부가 담겨 있다.
    - `isNewTransaction()`을 사용하면 신규 트랜잭션 여부를 확인할 수 있다.(true, false)
- 내부 트랜잭션의 트랜잭션 매니저가 기존 트랜잭션이 존재하는지 확인하고, 기존 트랜잭션에 참여하도록 한다.
    - 외부 트랜잭션에서 물리 트랜잭션을 시작했다.
    - 그리고 물리 트랜잭션이 시작된 커넥션을 트랜잭션 동기화 매니저에 담아두었다.
    - 이미 물리 트랜잭션이 진행중이므로, 이후 로직이 기존 커넥션을 사용하게 만드는 것이다. 

![](img/tx_propa_03.PNG)

- 로직이 끝나고 트랜잭션 매니저는 커밋 시점에 신규 트랜잭션 여부에 따라 다르게 동작하게 된다.
    - 내부 트랜잭션인 경우 신규 트랜잭션이 아니기 때문에 트랜잭션 매니저는 실제 커밋이나 롤백을 호출하지 않는다.
    - 실제 커넥션에 커밋이나 롤백을 호출하게 되면 물리 트랜잭션이 끝나버리기 때문에 실제 커밋 롤백을 호출하면 안된다.
    - 외부 트랜잭션인 경우에 신규 트랜잭션이므로 트랜잭션 매니저는 DB 커넥션에 실제 커밋 롤백을 호출한다.
- 트랜잭션 매니저에 커밋을 호출한다고 해서 항상 실제 커넥션에 물리 커밋이 발생하지는 않는다!!.

#

## 트랜잭션 전파 내부 롤백 상황

내부 트랜잭션이 롤백을 하는데 외부 트랜잭션이 커밋을 하게 된다면 스프링 트랜잭션 전파 원칙에 따라 물리 트랜잭션은 최종 롤백된다.

![](img/tx_propa_04.PNG)

- 내부 트랜잭션을 롤백하면 실제 물리 트랜잭션을 롤백하지는 않는다. 대신 기존 트랜잭션을 rollback-only로 마킹한다.
- 외부 트랜잭션 코드가 커밋을 요청해도 트랜잭션 매니저
