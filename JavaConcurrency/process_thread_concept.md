# Thread Concept

## Process
 
프로그램은 OS에 의해 설치되어 파일 시스템에 저장된 파일을 말한다. 프로세스는 프로그램의 데이터들이 메모리에 올라와 CPU를 할당받아 실행되고 있는 인스턴스이다.
  
OS는 프로세스마다 각각 독립된 메모리 영역(Code, Data, Stack, Heap)을 할당해주며, 덕분에 프로세스는 서로 영향을 받지 않고 독립적인 작업을 수행할 수 있다.
기본적으로 프로세스는 다른 프로세스의 변수나 자료에 접근할 수 없고 IPC(Inter-Process-Communication)나 공유메모리 등의 통신기법들을 사용해서 통신할 수 있다.

> - 동적할당
>   - Stack: 함수 안에서 선언된 지역변수, 매개변수, 리턴값 등이 저장된다. 함수의 호출과 함꼐 할당되며 함수의 호출이 완료되면 소멸된다.
>   - Heap: 사용자에 의해 메모리 공간이 동적으로 할당되고 해제된다. JVM이 관리하는 자바의 힙 영역이 포함되며 자바 힙 영역에서 자바 객체가 생성되고 GC에 의해 메모리 관리가 이루어진다.
> - 정적할당
>   - Data: 코드가 실행되면서 사용되는 전역변수, static 변수 등이 저장된다. 프로그램의 시작과 함께 할당되며 프로그램이 종료되면 소멸된다.
>   - Code: 사용자가 작성한 프로그램 함수들의 코드가 저장된다. CPU는 코드 영역에 저장된 명령어를 하나씩 가져가서 처리한다.

프로세스는 서로 독립적이기 때문에 여러 개의 자식 프로세스 중 하나에 문제가 발생해도 해당 자식 프로세스만 죽고 영향을 미치지 않는다. 하지만 상호 독립적인 특성 때문에 메모리 리소스 비용이 크고 프로세스 간 컨텍스트 스위칭 비용이 많이 발생한다.

### Context Switching

하나의 CPU 코어는 동일한 시간에 하나의 작업만 수행할 수 있고, 물리적으로 동시에 여러 프로세스를 실행할 수 없다. 코어가 한 번에 하나의 명령어만 처리할 수 있기 때문이다.
OS는 이러한 문제를 동시성으로 해결한다. 이 때 한 프로세스에서 다른 프로세스로의 전환, 컨텍스트 스위칭이 발생한다.
  
프로세스 간 전환을 위해서는 이전에 어디까지 명령을 수행했고, CPU 레지스터에는 어떤 값이 저장되어 있는지에 대한 정보가 필요하다.
프로세스의 이러한 정보들을 Context라고 말하는데, 이 정보들은 커널 안 OS가 관리하는 PCB 라고 하는 자료구조의 공간에 저장된다.

대략적인 컨텍스트 스위칭 과정은 현재 실행 중인 프로세스의 레지스터, 카운터 등의 상태를 PCB에 저장 및 다음 프로세스의 상태를 PCB에서 읽어와 레지스터 카운터 등에 복원하고 복원된 상태를 기반으로 다음 프로세스를 실행하는 과정으로 이루어진다.

컨텍스트 스위칭이 일어나는 조건은 다음과 같다.
- 실행 중인 프로세스에서 I/O 호출이 일어나 프로세스 상태가 Running 에서 Waiting 상태로 전이될 때.
  - 프로세스는 I/O 작업이 끝날때 까지 Waiting 상태에서 대기하다가 Ready 상태로 전이된다.
- OS의 CPU 스케줄링 알고리즘(Round Robin)에 의해 현재 실행중인 프로세스가 사용할 수 있는 시간 자원을 모두 사용했을 때 프로세스를 중지하고 다른 프로세스를 실행시켜주는 경우
  - OS 스케줄러는 매우 짧은 시간(10~100 micro sec)의 간격을 두고 프로세스를 교체하며 실행한다.

## Thread

스레드는 OS의 스케줄러에 의해 관리되는 CPU의 최소 실행 단위이다. 하나의 프로세스는 반드시 하나 이상의 스레드를 갖는다.
  
스레드는 프로세스의 자원을 이용하며, Stack 영역을 독립적으로 할당받고 Code, Data, Heap 영역은 각 스레드가 공유하여 사용한다.
Stack 영역을 독립적으로 할당받기 때문에, 각 스레드는 독립적인 함수 호출을 할 수 있다.
  
CPU는 OS 스케줄러에 의해 프로세스의 하나의 스레드를 점유하는데, 스레드 간 CPU 선점이 일어날 때 CPU의 실행 흐름(문맥)이 전환되는 컨텍스트 스위칭이 발생한다. 
프로세스의 메모리 영역을 공유하기 때문에 컨텍스트 스위칭 시간이 적고 리소스를 효율적으로 사용할 수 있다. 
  
메모리 영역을 공유한다는 특징 때문에 스레드 하나에 문제가 발생하면 전체 프로세스에 영향을 미치게 되고, 공유 메모리 영역 동시 접근으로 인한 동기화 문제가 발생할 수 있다.  

### Context Switching

스레드의 상태정보를 저장하는 자료구조를 TCB라고 하며, 카운터와 CPU 레지스터 정보, PCB를 가리키는 포인터를 가진다.
스레드가 하나 생성될 때마다 PCB 내에서 TCB가 생성되며 컨텍스트 스위칭이 일어나면 기존의 스레드 TCB를 저장하고 새로운 스레드의 TCB를 가져와 실행한다.
  
프로세스 컨텍스트 스위칭에 비해 오버헤드가 적고, 스위칭 속도가 빠르다. 그러나 많은 수의 스레드 생성은 메모리 부족 현상을 발생시키고 빈번한 컨텍스트 스위칭을 만들어 어플리케이션의 성능을 저하시킨다.

---

### Reference
- [자바 동시성 프로그래밍 \[리액티브 프로그래밍 Part.1\]](https://www.inflearn.com/course/%EC%9E%90%EB%B0%94-%EB%8F%99%EC%8B%9C%EC%84%B1-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EB%A6%AC%EC%95%A1%ED%8B%B0%EB%B8%8C-part1/dashboard)
