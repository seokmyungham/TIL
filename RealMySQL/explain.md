# 실행 계획

DBMS의 목적은 많은 데이터를 안전하게 저장 및 관리하고 사용자가 원하는 데이터를 빠르게 조회할 수 있도록 돕는 것이다.  
이를 달성하려면 옵티마이저가 사용자의 쿼리를 최적으로 처리될 수 있도록하는 `올바른 쿼리 실행계획`을 세울 수 있어야 한다.

옵티마이저가 항상 올바른 쿼리 실행계획을 세우는 것이 아니기 때문에  
DBMS는 관리자나 사용자가 옵티마이저가 수립한 실행 계획을 확인할 수 있는 `EXPLAIN` 명령어를 지원한다.

비용 기반 최적화에서 가장 중요한 것은 `통계 정보`다.  
통계 정보가 정확하지 않으면 옵티마이저는 엉뚱한 쿼리 실행계획을 수립하게 되고 비 효율적인 방향으로 쿼리를 실행하게 된다.  
> 실제로는 1억건의 레코드가 저장되어있지만 통계 정보가 갱신되지 않아 10건의 레코드가 저장되어 있는 것 처럼 되어있다면?

MySQL 5.5버전까지는 각 테이블의 통계 정보가 메모리에 저장되었지만, 5.6버전부터 테이블로 관리할 수 있도록 개선됐다.  
> `innodb_index_stats`, `innodb_table_stats`

또한 테이블을 생성할 때 `STATS_PERSISTENCE` 옵션을 설정해서 통계 정보를 메모리(휘발), 테이블 단위(비휘발)로 선택해서 결정하는 것이 가능하다.
> `STATS_PERSISTENCE`의 기본 값은 1, 테이블에 통계 정보를 저장한다.

MySQL 5.5 버전까지 메모리에 통계 정보를 저장함에 따라 서버가 재시작될 시 통계 정보가 초기화되거나  
사용자 혹은 관리자가 알지 못하는 순간에 통계 정보가 갱신되어 일관적이지 않은 쿼리 실행 계획이 수립되는 경우가 많았다.

- 테이블이 새로 오픈되는 경우
- 테이블의 레코드가 대량으로 변경되는 경우(테이블 전체 레코드의 1/16)
- ANALYZE TABLE 명령이 실행되는 경우
- SHOW TABLE STATUS 명령이나 SHOW INDEX FROM 명령이 실행되는 경우
- InnoDB 모니터가 활성화되는 경우
- innodb_stats_on_metadata 시스템 설정이 ON인 상태에서 SHOW TABLE STATUS 명령이 실행되는 경우
  
영구적인 통계 정보(테이블)가 도입되면서 이를 막을 수 있게 되었다. 추가로 `innodb_stats_auto_recalc` 옵션을 이용해서 자동으로 통계 정보를 갱신할지 선택할 수 있다.
OFF로 설정한다면 통계 정보가 자동적으로 갱신되는 것을 막고 원하는 시점의 영구적인 통계 정보를 이용하게 될 것이다.  
> 통계 정보를 자동으로 수집할지 여부도 테이블을 생성할 때 결정할 수 있다. `STATS_AUTO_RECALC` 옵션  
> 옵션을 1로 설정하면 위에 나열된 이벤트 발생 시마다 통계 정보를 업데이트한다. 기본 값은 0이다.
  
영구적인 통계 정보를 사용하면 MySQL 서버의 점검이나 사용량이 많지 않은 시간을 이용해 더 정확한 통계 정보를 수집할 수도 있다. 
더 정확한 통계 정보 수집에는 많은 시간이 소요되겠지만, 해당 통계 정보의 정확성에 의해 쿼리의 성능이 결정되기 때문에 충분히 시간을 투자할 가치가 있다.  

## 히스토그램
