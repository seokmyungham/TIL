# 쿼리 작성 및 최적화

## SELECT

### 서브쿼리

쿼리를 작성할 때 서브쿼리를 사용하면 단위 처리별로 쿼리를 독립적으로 작성할 수 있다.
조인처럼 여러 테이블을 섞어 두는 형태가 아니어서 쿼리의 가독성도 높아지며, 복잡한 쿼리도 손쉽게 작성할 수 있다.
8.0 버전부터는 서브쿼리 처리가 많이 개선됐다.
  
서브 쿼리는 여러 위치에서 사용될 수 있다. 대표적으로 SELECT 절과 FROM 절, WHERE 절이다.
사용되는 위치에 따라 쿼리의 성능 영향도와 MySQL 서버의 최적화 방법은 완전히 달라진다.

### SELECT 절 서브 쿼리

SELECT 절에 사용된 서브쿼리는 내부적으로 임시 테이블을 만들거나 쿼리를 비효율적으로 실행하게 만들지는 않는다.
그래서 서브쿼리가 적절히 인덱스를 사용할 수 있다면 크게 주의할 사항은 없다.
  
일반적으로 SELECT 절에 서브쿼리를 사용하면 그 서브쿼리는 항상 칼럼과 레코드가 하나인 결과를 반환해야 한다.
그 값이 NULL이든 아니든 레코드가 1건이 존재해야 한다는 것인데 MySQL에서는 이 체크 조건이 조금 느슨하다.

```SQL
mysql> SELECT emp_no, (SELECT dept_name FROM departments WHERE dept_name='Sales1')
    -> FROM dept_emp LIMIT 10;
+--------+--------------------------------------------------------------+
| emp_no | (SELECT dept_name FROM departments WHERE dept_name='Sales1') |
+--------+--------------------------------------------------------------+
| 110022 | NULL                                                         |
| 110085 | NULL                                                         |
| 110183 | NULL                                                         |
| 110303 | NULL                                                         |
| 110511 | NULL                                                         |
| 110725 | NULL                                                         |
| 111035 | NULL                                                         |
| 111400 | NULL                                                         |
| 111692 | NULL                                                         |
| 110114 | NULL                                                         |
+--------+--------------------------------------------------------------+

mysql> SELECT emp_no, (SELECT dept_name FROM departments)
    -> FROM dept_emp LIMIT 10;
ERROR 1242 (21000): Subquery returns more than 1 row

mysql> SELECT emp_no, (SELECT dept_no, dept_name FROM departments WHERE dept_name='Sales1')
    -> FROM dept_emp LIMIT 10;
ERROR 1241 (21000): Operand should contain 1 column(s)
```

- 첫 번째 쿼리에서 사용된 서브쿼리는 항상 결과가 0건이다. 하지만 첫 번째 쿼리는 에러를 발생시키지 않고 서브쿼리 결과가 NULL로 채워져서 반환된다.
- 두 번째 쿼리에서 서브쿼리가 2건 이상의 레코드르 반환하는 경우에는 에러가 나면서 쿼리가 종료된다.
- 세 번째 쿼리와 같이 SELECT 절에 사용된 서브쿼리가 2개 이상의 칼럼을 가져오려고 할 때도 에러가 발생한다.

즉 SELECT 절의 서브쿼리에는 `로우 서브쿼리`를 사용할 수 없고, 오로지 `스칼라 서브쿼리`만 사용할 수 있다.

> 서브쿼리는 만들어 내는 결과에 따라 스칼라 서브쿼리(Scalar subquery), 로우 서브쿼리(Row subquery)로 구분할 수 있다.
> 스칼라 서브쿼리는 레코드의 칼럼이 각각 하나인 결과를 만들어내는 서브쿼리며,
> 스칼라 서브쿼리보다 레코드 건수가 많거나 칼럼 수가 많은 결과를 만들어내는 서브쿼리를 로우 서브쿼리라고 한다.

가끔 조인으로 처리해도 되는 쿼리를 SELECT 서브 쿼리를 사용해서 작성할 때도 있는데, 서브쿼리로 실행될 때보다 조인으로 처리할 때가 조금 더 빠르다.
그래서 가능하면 조인으로 쿼리를 작성하는 것이 좋다.

### FROM 절 서브 쿼리
